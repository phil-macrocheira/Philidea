@page
@model TOTK.Website.Pages.totk_calculatorModel
@{
    ViewData["Title"] = "TOTK Damage Calculator";
}
@Html.AntiForgeryToken()

<style>
    body {
        background-image: url("background.webp");
    }
    h2 {
        color: white;
        font-size: 24px;
        position: absolute;
        padding: 0 10px;
        margin-top: -35px;
        background-image: url('background.webp');
    }
    h5 {
        font-size: 18px;
        color: white;
    }
    ul {
        color: white;
        list-style-type: none;
    }
</style>

<div class="container" >
    <!--WEAPON ROW/SECTION-->
    <div class="row section">
        <div class="totk-title" style="height:10px; margin-left:-12px; position:relative;">
            <h2>WEAPON</h2>
        </div>

        <!--WEAPON-->
        <div class="col-md-auto py-2">
            <h5>Weapon</h5>
            <!--WEAPON DROPDOWN-->
            <select name="SelectedWeaponName" class="form-control select2" id="weaponDropdown" style="width:18rem;" onchange="update('weapon');">
            @if (Model.Weapons != null) {
                @foreach (var weapon in Model.Weapons) {
                    <option value="@weapon.Name">@weapon.Name</option>
                }
            }
            </select>
        </div>

        <!--ATTACK UP MOD-->
        <div class="col-md-auto py-2" style="margin-right:3%">
            <h5>Attack Up Mod</h5>
            <div class="form-outline" style="width: 10rem;">
                <input asp-for="Input.AttackUpMod" class="form-control" id="numberAttackUpMod" type="number" value="0" min="0" max="0" onchange="update()" />
            </div>
        </div>

        <!--FUSE-->
        <div class="col-md-auto py-2" style="margin-right:3%;">
            <h5>Fuse</h5>
            <!--FUSE DROPDOWN-->
            <select name="SelectedFuseName" class="form-control select2 text-wrap" id="fuseDropdown" style="width:18rem;" onchange="update('fuse');">
                @if (Model.Fuses != null) {
                    @foreach (var fuse in Model.Fuses) {
                        <option value="@fuse.Name">@fuse.Name</option>
                    }
                }
            </select>
        </div>

        <!--DURABILITY-->
        <div class="col-md-auto py-2" style="margin-right:3%">
            <h5>Durability</h5>
            <div class="form-outline" style="width: 5rem;">
                <input asp-for="Input.Durability" class="form-control" id="numberDurability" type="number" value="40" min="1" max="40" onchange="update()" />
            </div>
        </div>

        <!--ATTACK TYPE-->
        <div class="col-md-auto py-2">
            <h5>Attack Type</h5>
            <select asp-for="Input.AttackType" class="form-select" id="attacktypeDropdown" style="width:11.5rem;" onchange="update()">
                <option selected>Standard Attack</option>
                <option value="Combo Finisher">Combo Finisher</option>
                <option value="Throw">Throw</option>
                <option value="Melee Projectile">Melee Projectile</option>
                <option value="Sneakstrike">Sneakstrike</option>
                <option value="Flurry Rush">Flurry Rush</option>
                <option value="Headshot">Headshot</option>
                <option value="Riju Lightning">Riju Lightning</option>
            </select>
        </div>
    </div>

    <!--PLAYER AND ENEMY ROW-->
    <div class="row">
        <!--PLAYER SECTION-->
        <div class="col-7 section" style="height:fit-content">
            <div class="totk-title" style="height:10px; position:relative;">
                <h2>PLAYER</h2>
            </div>

            <div class="row">
                <!--CURRENT HEARTS-->
                <div class="col-md-auto py-2">
                    <h5>Current Hearts</h5>
                    <div class="form-outline" style="width: 6rem;">
                        <input asp-for="Input.HP" class="form-control" id="numberHP" type="number" value="38" step="0.25" min="0.25" max="40" onchange="update()" />
                    </div>
                </div>

                <!--ARMOR/FOOD BUFF 1-->
                <div class="col-md-auto py-2">
                    <h5>Armor/Food Buffs</h5>
                    <select asp-for="Input.Buff1" id="buffDropdown1" class="form-select" style="width:15rem;" onchange="update()">
                        <option selected>None</option>
                        <option value="Attack Up (Lv1)">Attack Up (Lv1)</option>
                        <option value="Attack Up (Lv2)">Attack Up (Lv2)</option>
                        <option value="Attack Up (Lv3)">Attack Up (Lv3)</option>
                        <option value="Bone Weap. Prof.">Bone Weap. Prof.</option>
                        <option value="Hot Weather Attack">Hot Weather Attack</option>
                        <option value="Cold Weather Attack">Cold Weather Attack</option>
                        <option value="Stormy Weather Attack">Stormy Weather Attack</option>
                        <option value="Master Sword Beam Up">Master Sword Beam Up</option>
                    </select>
                </div>

                <!--ARMOR/FOOD BUFF 2-->
                <div class="col-md-auto py-2">
                    <select asp-for="Input.Buff2" id="buffDropdown2" class="form-select" style="width:15rem; margin-top:28px;" onchange="update()">
                        <option selected>None</option>
                        <option value="Attack Up (Lv1)">Attack Up (Lv1)</option>
                        <option value="Attack Up (Lv2)">Attack Up (Lv2)</option>
                        <option value="Attack Up (Lv3)">Attack Up (Lv3)</option>
                        <option value="Bone Weap. Prof.">Bone Weap. Prof.</option>
                        <option value="Hot Weather Attack">Hot Weather Attack</option>
                        <option value="Cold Weather Attack">Cold Weather Attack</option>
                        <option value="Stormy Weather Attack">Stormy Weather Attack</option>
                        <option value="Master Sword Beam Up">Master Sword Beam Up</option>
                    </select>
                </div>

                <!--PLAYER CHECKBOXES-->
                <div class="col-md-auto py-2" style="margin-top:34px;">
                    <div class="form-check">
                        <label class="form-check-label d-block" style="color:white;">
                            <input asp-for="Input.Wet" id="checkboxWet" class="form-check-input" type="checkbox" onchange="update()">Wet
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!--SPACE BETWEEN SECTIONS-->
        <div class="col-md-auto"></div>

        <!--ENEMY SECTION-->
        <div class="col-4 section-enemy" style="height:fit-content; width:fit-content;">
            <div class="totk-title" style="height:10px; position:relative;">
                <h2>ENEMY</h2>
            </div>
            
            <div class="row">
                <!--ENEMY-->
                <div class="col py-2">
                    <h5>Enemy</h5>
                    <!--ENEMY DROPDOWN-->
                    <select name="SelectedEnemyName" class="form-control select2 text-wrap" id="enemyDropdown" onchange="update('enemy');">
                        @if (Model.Enemies != null) {
                            @foreach (var enemy in Model.Enemies) {
                                <option value="@enemy.Name">@enemy.Name</option>
                            }
                        }
                    </select>
                </div>

                <!--ENEMY CHECKBOXES-->
                <div class="col py-2" style="margin-top:34px;">
                    <div class="form-check">
                        <label class="form-check-label d-block" style="color:white;">
                            <input asp-for="Input.Frozen" id="checkboxFrozen" class="form-check-input" type="checkbox" onchange="update()" disabled>Frozen
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!--RESULT-->
    <div class="section-result" style="margin-top:45px; margin-left:-10px; height:fit-content;">
        <div class="totk-title" style="height:10px; position:relative;">
            <h2>RESULT</h2>
        </div>

        <div class="row">
            <!--WEAPON RESULT SECTION-->
            <div class="col-md-4" style="margin-left:25px">
                <h5 id="WeaponNameText">Master Sword</h5>
                <!--WEAPON AND FUSE ICON ROW-->
                <div class="row">
                    <!--WEAPON ICON AND ATTACK POWER-->
                    <div class="col-md-auto icon position-relative;" style="width:128px; height:128px; margin-top:6px; margin-left: 8px; position:relative; overflow: hidden;">
                        <div class="position-absolute" style="bottom: 0; right:0; background-color: rgba(20,20,20,0.6); border-top-left-radius: 0.5rem; padding: 0.5rem;">
                            <span id="AttackPowerText" class="text-white" style="font-size: 1rem;">30</span>
                        </div>
                        <img src="@Model.WeaponIconURL" id="weaponImage" class="rounded float-left" alt="Weapon Image" style="height:100%; width:100%; object-fit:contain;">
                    </div>
                    <!--FUSE ICON-->
                    <div class="col-md-auto icon" style="width:60px; height:60px; margin-left:3px; margin-top:6px;">
                        <img src="@Model.FuseIconURL" id="fuseImage" class="rounded float-left" alt="Fuse Image" style="height:100%; width:100%; object-fit:contain;">
                    </div>
                </div>

                <!--PROPERTIES TEXT-->
                <div class="row">
                    <div style="margin-top:6px;margin-left:-26px;">
                        <ul id="PropertiesList"><li>Cut</li></ul>
                    </div>
                </div>
            </div>

            <!--ENEMY RESULT SECTION-->
            <div class="col-md-4" style="margin-left:18px;">
                <h5 class="ml-3" id="EnemyNameText">Chuchu (Small)</h5>
                <!--ENEMY ICON AND HP-->
                <div class="icon position-relative;" style="width:128px; height:128px; margin-top:6px; position:relative; overflow: hidden;">
                    <div class="position-absolute" style="bottom: 0; right:0; background-color: rgba(20,20,20,0.6); border-top-left-radius: 0.5rem; padding: 0.5rem;">
                        <span id="HPText" class="text-white" style="font-size: 1rem;">10</span>
                    </div>
                    <img src="@Model.EnemyIconURL" id="enemyImage" class="float-left matched-radius_inner" alt="Enemy Image" style="height:100%; width:100%; object-fit:contain; border-radius: 0.7rem;">
                </div>
            </div>

            <!--DAMAGE OUTPUT SECTION-->
            <div class="col-md-2">
                <h5 style="margin-left:26px;">Damage</h5>
                <h1 class="icon" id="DamageOutputText" style="width:128px; height:128px; font-size: 48px; background-color:rgba(40, 40, 40, 0.5); display: flex; align-items: center; justify-content: center;">@Model.DamageOutput</h1>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#weaponDropdown').select2();
            $('#weaponDropdown').on('select2:open', function () {
                window.setTimeout(function () {
                    document.querySelector('.select2-search__field').focus();
                }, 0);
            });

            $('#fuseDropdown').select2();
            $('#fuseDropdown').on('select2:open', function () {
                window.setTimeout(function () {
                    document.querySelector('.select2-search__field').focus();
                }, 0);
            });

            $('#enemyDropdown').select2();
            $('#enemyDropdown').on('select2:open', function () {
                window.setTimeout(function () {
                    document.querySelector('.select2-search__field').focus();
                }, 0);
            });
        });

        function findObjByName(objData, selectedName) {
            return objData.find(function (w) {
                return w.Name === selectedName;
            });
        }

        function update(dropdownEdited) {
            var weaponData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Weapons));
            var fuseData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Fuses));
            var enemyData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Enemies));

            var selectedWeaponName = $('#weaponDropdown').val();
            var selectedFuseName = $('#fuseDropdown').val();
            var selectedEnemyName = $('#enemyDropdown').val();

            var selectedWeaponObj = findObjByName(weaponData, selectedWeaponName);
            var selectedFuseObj = findObjByName(fuseData, selectedFuseName);
            var selectedEnemyObj = findObjByName(enemyData, selectedEnemyName);

            // UPDATE MASTER SWORD ICON FOR FUSED/NOT FUSED
            var MasterSwordIconSet = false;
            if (dropdownEdited == 'weapon' || dropdownEdited == 'fuse') {
                if (selectedWeaponObj.Name == "Master Sword") {
                    if (selectedFuseObj.Name != "None") {
                        $('#weaponImage').prop('src', selectedWeaponObj ?
                            "https://raw.githubusercontent.com/TOTKSheet/TOTKImages/main/Weapons/Weapon_Sword_070_Attached.png" : '');
                        MasterSwordIconSet = true;
                    }
                    else {
                        $('#weaponImage').prop('src', selectedWeaponObj ? selectedWeaponObj.IconURL : '');
                        MasterSwordIconSet = true;
                    }
                }
                else if (selectedWeaponObj.Name == "Master Sword (Awakened +15)" || selectedWeaponObj.Name == "Master Sword (Awakened +30)") {
                    if (selectedFuseObj.Name != "None") {
                        $('#weaponImage').prop('src', selectedWeaponObj ?
                            "https://raw.githubusercontent.com/TOTKSheet/TOTKImages/main/Weapons/Weapon_Sword_070_TrueForm_Attached.png" : '');
                        MasterSwordIconSet = true;
                    }
                    else {
                        $('#weaponImage').prop('src', selectedWeaponObj ? selectedWeaponObj.IconURL : '');
                        MasterSwordIconSet = true;
                    }
                }
            }

            // UPDATE ICON AND ENEMY TEXT
            switch (dropdownEdited) {
                case 'weapon':
                    if (!MasterSwordIconSet) {
                        $('#weaponImage').prop('src', selectedWeaponObj ? selectedWeaponObj.IconURL : '');
                    }
                    break;
                case 'fuse':
                    $('#fuseImage').prop('src', selectedFuseObj ? selectedFuseObj.IconURL : '');
                    break;
                case 'enemy':
                    var HP = selectedEnemyObj.HP.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                    $('#HPText').text(HP);

                    $('#EnemyNameText').text(selectedEnemyObj.Name);
                    $('#enemyImage').prop('src', selectedEnemyObj ? selectedEnemyObj.IconURL : '');
                    break;
            }

            // UPDATE MAX DURABILITY IF WEAPON OR FUSE EDITED
            if (dropdownEdited === 'weapon' || dropdownEdited === 'fuse') {
                var FuseDurability = 0;
                var DurabilityMod = 0;
                var FuseDurabilityWeapon = selectedFuseObj.WeaponDurability;

                if (selectedWeaponObj.CanHaveAttackUpMod === true) {
                    DurabilityMod = 10;
                }

                if (FuseDurabilityWeapon > 0) 
                { 
                    FuseDurability = Math.min(selectedWeaponObj.FuseExtraDurability, FuseDurabilityWeapon);
                }
                else if (selectedFuseObj.Name != "None")
                {
                    FuseDurability = selectedWeaponObj.FuseExtraDurability;
                }

                var MaxDurability = selectedWeaponObj.Durability + FuseDurability;
                $('#numberDurability').attr('max', MaxDurability + DurabilityMod);
                $('#numberDurability').val(MaxDurability);
            }

            // TRIGGER IF WEAPON DROPDOWN EDITED
            if (dropdownEdited === 'weapon') {
                // UPDATE ATTACK UP MOD MAXIMUM
                if (selectedWeaponObj.CanHaveAttackUpMod === false) {
                    $('#numberAttackUpMod').prop('max', 0);
                    $('#numberAttackUpMod').val(0);
                }
                else {
                    $('#numberAttackUpMod').prop('max', 10);
                }

                // UPDATE FUSE DROPDOWN AND ICON
                if (selectedWeaponObj.Type == 3) {
                    var FusesArrow = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.FusesArrow));
                    var fuseDropdown = $('#fuseDropdown');
                    var selectedFuseName = fuseDropdown.val();

                    fuseDropdown.empty();
                    $.each(FusesArrow, function (index, fuse) {
                        fuseDropdown.append('<option value="' + fuse.Name + '">' + fuse.Name + '</option>');
                    });

                    fuseDropdown.val(FusesArrow[0].Name);
                    $('#fuseImage').prop('src',"https://raw.githubusercontent.com/TOTKSheet/TOTKImages/main/Items/Obj_OneTouchBond.png");
                }
                else {
                    var Fuses = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Fuses));
                    var fuseDropdown = $('#fuseDropdown');
                    var selectedFuseName = fuseDropdown.val();

                    fuseDropdown.empty();
                    $.each(Fuses, function (index, fuse) {
                        fuseDropdown.append('<option value="' + fuse.Name + '">' + fuse.Name + '</option>');
                    });

                    fuseDropdown.val(selectedFuseName);
                }
            }

            // Freeze Frozen Checkbox if enemy unfreezable
            if (dropdownEdited === 'enemy') {
                var checkbox = document.getElementById('checkboxFrozen');
                if (!selectedEnemyObj.CanFreeze) {
                    checkbox.checked = false;
                    checkbox.disabled = true;
                }
                else {
                    checkbox.disabled = false;
                }
            }

            // Clamp numbers (0 if NaN)
            var AttackUpModClamped = 0;
            var PlayerHPClamped = 0;
            var DurabilityClamped = 0;
            if (!isNaN($('#numberAttackUpMod').val())) {
                AttackUpModClamped = Math.min(2147483647, parseInt($('#numberAttackUpMod').val(), 10));
            }
            if (!isNaN($('#numberHP').val())) {
                PlayerHPClamped = Math.min(40, parseFloat($('#numberHP').val()));
            }
            if (!isNaN($('#numberDurability').val())) {
                DurabilityClamped = Math.min(810, parseInt($('#numberDurability').val(), 10));
            }

            var data = {
                AttackUpMod: AttackUpModClamped,
                AttackType: $('#attacktypeDropdown').val(),
                DurabilityInput: DurabilityClamped,
                Wet: $('#checkboxWet').is(':checked'),
                Frozen: $('#checkboxFrozen').is(':checked'),
                PlayerHP: PlayerHPClamped,
                Buff1: $('#buffDropdown1').val(),
                Buff2: $('#buffDropdown2').val(),
                
                NameWeapon: selectedWeaponObj.Name,
                Type: selectedWeaponObj.Type,
                CanCutWeapon: selectedWeaponObj.CanCut,
                BaseAttackWeapon: selectedWeaponObj.BaseAttack,
                ProjectileAttackWeapon: selectedWeaponObj.ProjectileAttack,
                Durability: selectedWeaponObj.Durability,
                Property: selectedWeaponObj.Property,
                CanHaveAttackUpMod: selectedWeaponObj.CanHaveAttackUpMod,
                CanFuseTo: selectedWeaponObj.CanFuseTo,
                FuseExtraDurability: selectedWeaponObj.FuseExtraDurability,
                FuseBaseName: selectedWeaponObj.FuseBaseName,
                NamingRuleWeapon: selectedWeaponObj.NamingRule,

                NameFuse: selectedFuseObj.Name,
                BaseAttackFuse: selectedFuseObj.BaseAttack,
                ProjectileAttackFuse: selectedFuseObj.ProjectileAttack,
                ElementPower: selectedFuseObj.ElementPower,
                WeaponDurability: selectedFuseObj.WeaponDurability,
                CanFuseToArrow: selectedFuseObj.CanFuseToArrow,
                ArrowMultiplierFuse: selectedFuseObj.ArrowMultiplier,
                CanCutFuse: selectedFuseObj.CanCut,
                AddsShieldAttack: selectedFuseObj.AddsShieldAttack,
                ReplaceProperties: selectedFuseObj.ReplaceProperties,
                Property1: selectedFuseObj.Property1,
                Property2: selectedFuseObj.Property2,
                Property3: selectedFuseObj.Property3,
                NamingRuleFuse: selectedFuseObj.NamingRule,
                Adjective: selectedFuseObj.Adjective,
                BindTypeSword: selectedFuseObj.BindTypeSword,
                BindTypeSpear: selectedFuseObj.BindTypeSpear,

                NameEnemy: selectedEnemyObj.Name,
                EnemyHP: selectedEnemyObj.HP,
                Element: selectedEnemyObj.Element,
                FireDamage: selectedEnemyObj.FireDamage,
                FireDamageContinuous: selectedEnemyObj.FireDamageContinuous,
                CanFreeze: selectedEnemyObj.CanFreeze,
                IceDamage: selectedEnemyObj.IceDamage,
                ShockDamage: selectedEnemyObj.ShockDamage,
                WaterDamage: selectedEnemyObj.WaterDamage,
                RijuDamage: selectedEnemyObj.RijuDamage,
                AncientBladeDefeat: selectedEnemyObj.AncientBladeDefeat,
                IsRock: selectedEnemyObj.IsRock,
                CanSneakstrike: selectedEnemyObj.CanSneakstrike,
                CanMeleeHeadshot: selectedEnemyObj.CanMeleeHeadshot,
                HeadshotMultiplier: selectedEnemyObj.HeadshotMultiplier,
                ArrowMultiplierEnemy: selectedEnemyObj.ArrowMultiplier,
                BeamMultiplier: selectedEnemyObj.BeamMultiplier,
                BombMultiplier: selectedEnemyObj.BombMultiplier,
            };

            $.ajax({
                headers: {
                    RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                type: 'POST',
                url: '@Url.Page("Index/totk-calculator")',
                contentType: 'application/x-www-form-urlencoded',
                data: data,
                success: function (response) {
                    if (selectedFuseObj.Name == "None") {
                        if (selectedWeaponName == "Master Sword (Prologue)") {
                            $('#WeaponNameText').text("MsgNotFound");
                        }
                        else if (selectedWeaponName == "Master Sword (Awakened +15)" || selectedWeaponName == "Master Sword (Awakened +30)") {
                            $('#WeaponNameText').text("Master Sword");
                        }
                        else {
                            $('#WeaponNameText').text(selectedWeaponName);
                        }
                    }
                    else {
                        $('#WeaponNameText').text(response.fusedName);
                    }

                    $('#DamageOutputText').text(response.damageOutput);
                    $('#AttackPowerText').text(response.attackPowerUI);

                    $('#PropertiesList').empty();
                    $.each(response.properties, function (index, property) {
                        $('#PropertiesList').append('<li>' + property + '</li>');
                    });

                    console.log('UPDATE SUCCESS', response);
                },
                error: function (error) {
                    console.error('UPDATE ERROR', error);
                }
            });
        }
    </script>

    <script>
    // Armor/Food Buff Dropdown Duplicate Logic
        function updateDropdowns() {
            // Show all options
            $('#buffDropdown1 option, #buffDropdown2 option').show();

            // Hide selected options in the other dropdown
            var selectedValue1 = $('#buffDropdown1').val();
            var selectedValue2 = $('#buffDropdown2').val();

            if (selectedValue1 !== 'None' && selectedValue1.startsWith('Attack Up')) {
                $('#buffDropdown2').find('option[value^="Attack Up"]').not(':selected').hide();
            } else if (selectedValue1 !== 'None') {
                $('#buffDropdown2').find('option[value="' + selectedValue1 + '"]').not(':selected').hide();
            }

            if (selectedValue2 !== 'None' && selectedValue2.startsWith('Attack Up')) {
                $('#buffDropdown1').find('option[value^="Attack Up"]').not(':selected').hide();
            } else if (selectedValue2 !== 'None') {
                $('#buffDropdown1').find('option[value="' + selectedValue2 + '"]').not(':selected').hide();
            }
        }

        $(document).ready(function () {
            $('#buffDropdown1, #buffDropdown2').on('change', function () {
                updateDropdowns();
            });
        });
    </script>
}